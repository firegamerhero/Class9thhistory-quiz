<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITANIUM V8: APEX SUITE</title>
    
    <style>
        /* ==========================================================================
           1. CORE CSS VARIABLES & THEME ENGINE
           ==========================================================================
        */
        :root {
            /* SYSTEM DEFAULTS */
            --primary: #ffffff;
            --secondary: #a0a0a0;
            --accent: #00d9ff;
            
            --bg-deep: #050505;
            --panel-bg: rgba(18, 18, 24, 0.90); /* Darker for better text contrast */
            --glass-border: rgba(255, 255, 255, 0.15);
            
            --font-stack: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --shadow-glow: 0 0 25px rgba(0, 217, 255, 0.2);
            
            --correct-green: #00ff88;
            --wrong-red: #ff3355;
        }

        /* HISTORY THEME (CYBER BLUE) */
        body.mode-history {
            --primary: #00f2ff;
            --secondary: #006aff;
            --accent: #00f2ff;
            --bg-deep: #020b14;
            --shadow-glow: 0 0 40px rgba(0, 242, 255, 0.3);
        }

        /* CIVICS THEME (PARLIAMENT GOLD) */
        body.mode-civics {
            --primary: #ffcc00;
            --secondary: #ff8800;
            --accent: #ffcc00;
            --bg-deep: #140f00;
            --shadow-glow: 0 0 40px rgba(255, 204, 0, 0.3);
        }

        /* EXAM THEME (CRITICAL RED) */
        body.mode-exam {
            --primary: #ff0055;
            --secondary: #cc0000;
            --accent: #ff0055;
            --bg-deep: #140005;
            --shadow-glow: 0 0 50px rgba(255, 0, 85, 0.5);
        }

        /* ADMIN THEME (MATRIX GREEN) */
        body.mode-admin {
            --primary: #00ff00;
            --secondary: #004400;
            --accent: #00ff00;
            --bg-deep: #000a00;
            font-family: 'Courier New', monospace;
        }

        /* ==========================================================================
           2. GLOBAL LAYOUT & RESET
           ==========================================================================
        */
        * { 
            margin: 0; padding: 0; 
            box-sizing: border-box; 
            font-family: var(--font-stack); 
            -webkit-tap-highlight-color: transparent; 
        }
        
        body {
            background-color: var(--bg-deep);
            color: white;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: background 0.8s ease;
        }

        /* DYNAMIC CANVAS LAYERS */
        #bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0.5; }
        #vfx-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        /* LOADER OVERLAY */
        #system-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader-ring {
            width: 70px; height: 70px; 
            border: 6px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent); 
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ==========================================================================
           3. MAINFRAME UI (GLASSMORPHISM)
           ==========================================================================
        */
        .mainframe {
            width: 98%; max-width: 1300px; height: 97vh;
            background: var(--panel-bg);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: 0 30px 90px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            overflow: hidden; position: relative;
            transition: border-color 0.5s ease, box-shadow 0.5s ease;
        }

        /* HEADER */
        header {
            height: 80px; border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; background: rgba(0,0,0,0.3); z-index: 100;
        }
        .brand-logo h1 {
            font-size: 1.8rem; font-weight: 900; color: var(--primary);
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 15px var(--primary); transition: color 0.5s;
        }
        .brand-logo span { font-size: 0.8rem; color: #888; letter-spacing: 1px; display: block; }

        .header-controls { display: flex; align-items: center; gap: 15px; }
        
        .user-pill {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border);
            padding: 8px 20px; border-radius: 30px; font-size: 0.9rem; color: #fff;
            display: none; align-items: center; gap: 10px; font-weight: bold;
        }
        
        .icon-btn {
            background: none; border: 1px solid var(--glass-border); color: var(--primary);
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            transition: 0.3s;
        }
        .icon-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary); transform: scale(1.1); }

        /* ==========================================================================
           4. SCREEN MANAGER
           ==========================================================================
        */
        .screen-layer {
            flex: 1; position: relative; overflow: hidden; width: 100%;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* Hidden state */
            flex-direction: column; align-items: center;
            padding: 20px 40px; 
            overflow-y: auto; /* SCROLL IF CONTENT IS LONG */
            opacity: 0; transform: scale(0.96) translateY(20px);
            transition: opacity 0.4s var(--ease-elastic), transform 0.4s var(--ease-elastic);
        }
        
        .screen.active {
            display: flex; opacity: 1; transform: scale(1) translateY(0); z-index: 10;
        }

        /* CUSTOM SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ==========================================================================
           5. UI COMPONENTS (Buttons, Inputs)
           ==========================================================================
        */
        /* HERO BUTTONS */
        .btn-titan {
            padding: 16px 50px; border-radius: 50px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff; font-weight: 900; font-size: 1.2rem; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4); transition: 0.3s;
            position: relative; overflow: hidden; margin-top: 20px;
        }
        .btn-titan:hover { transform: translateY(-3px); box-shadow: var(--shadow-glow); }
        .btn-titan:active { transform: scale(0.97); }

        /* NAV BUTTONS (Back) */
        .btn-nav {
            align-self: flex-start; margin-bottom: 20px;
            background: rgba(255,255,255,0.05); color: #ccc; border: 1px solid var(--glass-border);
            padding: 10px 25px; border-radius: 30px; cursor: pointer; transition: 0.3s;
            font-weight: bold; font-size: 0.9rem;
        }
        .btn-nav:hover { background: #fff; color: #000; border-color: #fff; }

        /* INPUT FIELDS */
        .holo-field {
            width: 100%; padding: 18px; background: rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border); color: #fff; border-radius: 12px;
            font-size: 1.1rem; margin-bottom: 25px; outline: none; transition: 0.3s;
        }
        .holo-field:focus { border-color: var(--primary); box-shadow: 0 0 20px var(--primary); background: rgba(0,0,0,0.7); }

        /* ==========================================================================
           6. SPECIFIC SCREENS DESIGN
           ==========================================================================
        */
        /* LOGIN */
        .login-card {
            background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border);
            padding: 60px; border-radius: 25px; width: 100%; max-width: 500px;
            text-align: center; box-shadow: 0 30px 80px rgba(0,0,0,0.7);
            backdrop-filter: blur(15px); margin-top: 5vh;
        }

        /* STUDENT DASHBOARD */
        .dash-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px; width: 100%; max-width: 1100px; margin-top: 20px;
        }
        .dash-card {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 25px; border-radius: 20px; display: flex; flex-direction: column;
            transition: 0.3s;
        }
        .dash-card:hover { background: rgba(255,255,255,0.06); border-color: var(--primary); }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 1rem; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: var(--primary); }
        .history-list { max-height: 250px; overflow-y: auto; font-size: 0.9rem; }
        .hist-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); color: #eee; }

        /* MODULES (History/Civics) */
        .mod-container { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; width: 100%; margin-top: 40px; }
        .mod-box {
            width: 280px; height: 360px; background: rgba(255,255,255,0.02);
            border: 1px solid var(--glass-border); border-radius: 25px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.4s; position: relative; overflow: hidden;
        }
        .mod-box:hover { 
            transform: translateY(-15px) scale(1.02); 
            border-color: var(--primary); 
            background: rgba(255,255,255,0.08); 
            box-shadow: var(--shadow-glow); 
        }
        .mod-ico { font-size: 6rem; margin-bottom: 25px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.1)); transition: 0.4s; }
        .mod-box:hover .mod-ico { transform: scale(1.1) rotate(5deg); }
        
        /* QUIZ INTERFACE (The Critical Part) */
        .hud-bar {
            width: 100%; max-width: 1000px; display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: rgba(0,0,0,0.6); border-radius: 50px; 
            border: 1px solid var(--glass-border); margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .hud-val { font-family: 'Courier New', monospace; font-weight: bold; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }

        .q-display { 
            font-size: 1.8rem; text-align: center; margin-bottom: 50px; 
            width: 100%; max-width: 1000px; line-height: 1.5; min-height: 100px; 
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
            /* Fix for text overflow */
            word-wrap: break-word; overflow-wrap: break-word;
        }

        /* MCQ BUTTONS */
        .mcq-container { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; width: 100%; max-width: 1000px; }
        
        .option-btn {
            background: rgba(255,255,255,0.04); border: 2px solid var(--glass-border);
            padding: 25px; border-radius: 15px; cursor: pointer; 
            text-align: center; font-size: 1.2rem; font-weight: 500;
            transition: 0.2s; position: relative; color: #ddd;
            /* Fix for text overflow in buttons */
            white-space: normal; line-height: 1.4; min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        
        .option-btn:hover { background: rgba(255,255,255,0.1); border-color: #fff; transform: translateY(-3px); }
        
        /* Highlight Correct/Wrong */
        .option-btn.correct { 
            background: rgba(0, 255, 136, 0.2) !important; 
            border-color: var(--correct-green) !important; 
            color: var(--correct-green) !important; 
            box-shadow: 0 0 30px rgba(0,255,136,0.3);
        }
        
        .option-btn.wrong { 
            background: rgba(255, 51, 85, 0.2) !important; 
            border-color: var(--wrong-red) !important; 
            color: var(--wrong-red) !important; 
            opacity: 0.7;
        }
        .option-btn.wrong::after { content: "‚ùå"; position: absolute; right: 20px; }
        .option-btn.correct::after { content: "‚úî"; position: absolute; right: 20px; }

        /* LIFELINE BUTTON (50/50) */
        .lifeline-area { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; width: 100%; }
        .life-btn {
            background: rgba(0,0,0,0.5); border: 1px solid var(--primary); color: var(--primary);
            padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
        }
        .life-btn:disabled { opacity: 0.3; cursor: not-allowed; border-color: #555; color: #555; }

        @media (max-width: 800px) {
            .mcq-container { grid-template-columns: 1fr; }
            .mod-box { width: 100%; height: 120px; flex-direction: row; justify-content: flex-start; padding: 0 30px; }
            .mod-ico { font-size: 3rem; margin: 0 20px 0 0; }
            .q-display { font-size: 1.4rem; }
        }

        /* RESULT */
        .result-paper {
            background: #fff; color: #111; padding: 60px; width: 100%; max-width: 550px;
            border-radius: 10px; text-align: center; position: relative;
            transform: rotate(-1deg); box-shadow: 0 0 120px rgba(0,0,0,0.9);
            animation: paperDrop 0.8s var(--ease-elastic);
        }
        @keyframes paperDrop { from { opacity: 0; transform: translateY(-100px) scale(0.8) rotate(5deg); } to { opacity: 1; transform: translateY(0) scale(1) rotate(-1deg); } }
        
        .stamp {
            position: absolute; top: 40%; right: 30px;
            border: 8px solid #000; font-size: 5rem; font-weight: 900;
            padding: 15px; transform: rotate(-20deg) scale(2); opacity: 0;
            animation: stampIn 0.3s 1s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes stampIn { to { opacity: 0.7; transform: rotate(-20deg) scale(1); } }
        .stamp.pass { color: #009900; border-color: #009900; }
        .stamp.fail { color: #cc0000; border-color: #cc0000; }

        /* ADMIN TABLE */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; font-family: monospace; }
        .admin-table th { text-align: left; border-bottom: 1px solid var(--primary); color: var(--primary); padding: 12px; }
        .admin-table td { border-bottom: 1px solid #333; padding: 12px; color: #ccc; }
        .admin-table tr:hover td { background: rgba(0,255,0,0.1); color: #fff; }

    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <canvas id="vfx-canvas"></canvas>
    
    <div id="system-loader">
        <div class="loader-ring"></div>
        <p style="margin-top:25px; color:#aaa; font-family:monospace; letter-spacing:4px; font-size:1.2rem;">SYSTEM INITIALIZING...</p>
    </div>

    <div class="mainframe">
        <header>
            <div class="brand-logo">
                <h1>Titanium <span style="font-weight:100; opacity:0.6;">V8</span></h1>
                <span>ACADEMIC SUITE</span>
            </div>
            <div class="header-controls">
                <div class="user-pill" id="user-display">
                    <span id="u-name">Student</span>
                    <span style="opacity:0.5;">|</span>
                    <span id="u-roll">00</span>
                </div>
                <button class="icon-btn" onclick="AudioSys.toggleMusic()" title="Toggle Ambience">üéµ</button>
                <button class="icon-btn" onclick="AudioSys.toggle()" title="Toggle SFX">üîä</button>
            </div>
        </header>

        <div class="screen-layer">

            <div id="scr-login" class="screen active">
                <div class="login-card">
                    <h2 style="margin-bottom:40px; font-weight:300; letter-spacing:3px;">SECURE LOGIN</h2>
                    
                    <input type="text" id="inp-name" class="holo-field" placeholder="FULL NAME">
                    <input type="number" id="inp-roll" class="holo-field" placeholder="ROLL NUMBER">
                    <select id="inp-sec" class="holo-field" style="background:#111;">
                        <option>Section A</option>
                        <option>Section B</option>
                        <option>Section C</option>
                    </select>

                    <button class="btn-titan" onclick="Core.login()">ACCESS PORTAL</button>
                    <p style="margin-top:30px; font-size:0.8rem; color:#666;">Annual Assessment System 2026</p>
                </div>
            </div>

            <div id="scr-dashboard" class="screen">
                <h2 style="font-size:2.2rem; letter-spacing:1px; margin-bottom:20px;">DASHBOARD</h2>
                <div class="dash-grid">
                    <div class="dash-card">
                        <h3 style="color:var(--primary); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">STUDENT PROFILE</h3>
                        <div class="stat-row"><span>Name</span> <span style="color:#fff" id="dash-name">--</span></div>
                        <div class="stat-row"><span>Roll / Sec</span> <span style="color:#fff" id="dash-roll">--</span></div>
                        <div class="stat-row"><span>Status</span> <span style="color:lime">ONLINE</span></div>
                    </div>
                    
                    <div class="dash-card">
                        <h3 style="color:var(--primary); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">PERFORMANCE</h3>
                        <div class="stat-row"><span>Tests Taken</span> <span class="stat-val" id="dash-tests">0</span></div>
                        <div class="stat-row"><span>Best Score</span> <span class="stat-val" id="dash-best">0</span></div>
                    </div>

                    <div class="dash-card" style="grid-column: 1 / -1;">
                        <h3 style="color:var(--primary); margin-bottom:20px; border-bottom:1px solid #333; padding-bottom:10px;">RECENT ACTIVITY LOG</h3>
                        <div class="history-list" id="dash-history">
                            <div style="text-align:center; color:#555; margin-top:30px;">No activity recorded yet.</div>
                        </div>
                    </div>
                </div>
                <div style="display:flex; gap:20px; margin-top:30px;">
                    <button class="btn-titan" onclick="Core.nav('scr-modules')">START NEW TEST</button>
                    <button class="btn-nav" style="border-color:red; color:red; margin-top:20px;" onclick="Core.logout()">LOGOUT</button>
                </div>
            </div>

            <div id="scr-modules" class="screen">
                <button class="btn-nav" onclick="Core.nav('scr-dashboard')">‚Üê DASHBOARD</button>
                <h2 style="font-size:2.5rem; letter-spacing:2px; margin-bottom:40px;">SELECT MODULE</h2>
                
                <div class="mod-container">
                    <div class="mod-box" onclick="Core.setTheme('history')">
                        <div class="mod-ico">üìú</div>
                        <h3>HISTORY</h3>
                    </div>
                    <div class="mod-box" onclick="Core.setTheme('civics')">
                        <div class="mod-ico">‚öñÔ∏è</div>
                        <h3>CIVICS</h3>
                    </div>
                    <div class="mod-box" onclick="Core.setTheme('exam')">
                        <div class="mod-ico">üìù</div>
                        <h3>MOCK EXAM</h3>
                    </div>
                </div>
            </div>

            <div id="scr-chapters" class="screen">
                <button class="btn-nav" onclick="Core.nav('scr-modules')">‚Üê MODULES</button>
                <h2 id="ch-title" style="margin-bottom:30px; color:var(--primary); font-size:2rem;">CHAPTERS</h2>
                <div class="mod-container" id="ch-list" style="justify-content: flex-start; gap: 20px;"></div>
            </div>

            <div id="scr-quiz" class="screen">
                <div class="lifeline-area" id="lifelines" style="display:none;">
                    <button class="life-btn" onclick="Core.useLifeline('5050', this)">50/50</button>
                    <button class="life-btn" onclick="AudioSys.readQuestion()">üó£Ô∏è READ</button>
                </div>

                <div class="hud-bar">
                    <span class="hud-val" id="timer">00:00</span>
                    <span class="hud-val" id="tracker">1/50</span>
                    <span class="hud-val" style="color:#fff;">PTS: <span id="score-box" style="color:var(--primary)">0</span></span>
                </div>
                
                <div class="q-display" id="q-text">Loading...</div>

                <div class="mcq-container" id="mcq-area"></div>

                <div id="text-area" style="display:none; width:100%; max-width:700px; flex-direction:column; gap:20px;">
                    <input type="text" id="txt-ans" class="holo-field" placeholder="Type your answer here..." style="font-size:1.3rem;">
                    <button class="btn-titan" onclick="Core.checkText()">SUBMIT ANSWER</button>
                    <div id="hint-msg" style="text-align:center; color:#ff4444; display:none; font-size:1.2rem; font-weight:bold;"></div>
                </div>
            </div>

            <div id="scr-result" class="screen">
                <div class="result-paper">
                    <div style="border-bottom:3px solid #000; margin-bottom:20px; padding-bottom:15px;">
                        <h2 style="font-size:2.5rem; font-weight:900;">REPORT CARD</h2>
                        <p style="color:#555; font-size:1rem; font-weight:bold;">ANNUAL SESSION 2026</p>
                    </div>
                    <div style="text-align:left; font-size:1.2rem; line-height:1.8; color:#222;">
                        <p><strong>Name:</strong> <span id="res-name">--</span></p>
                        <p><strong>Roll No:</strong> <span id="res-roll">--</span></p>
                        <p><strong>Subject:</strong> <span id="res-sub">--</span></p>
                        <p><strong>Date:</strong> <span id="res-date">--</span></p>
                    </div>
                    <div style="margin:40px 0;">
                        <span style="font-size:5rem; font-weight:900;" id="res-score">0</span>
                        <span style="font-size:2.5rem; color:#888;">/50</span>
                    </div>
                    <div class="stamp" id="res-stamp">PASS</div>
                </div>
                <div style="display:flex; gap:20px; margin-top:40px;">
                    <button class="btn-titan" onclick="Core.finishToDash()">RETURN TO DASHBOARD</button>
                    <button class="btn-nav" style="border-color:red; color:red;" onclick="Core.logout()">LOGOUT</button>
                </div>
            </div>

            <div id="scr-admin" class="screen">
                <div style="width:100%; max-width:1000px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="color:var(--primary); font-size:2rem;">ADMIN CONSOLE [SNEHA]</h2>
                        <button class="btn-nav" style="border-color:var(--primary); color:var(--primary); margin:0;" onclick="Core.logout()">EXIT</button>
                    </div>
                    
                    <div style="background:rgba(0,30,0,0.9); border:1px solid var(--primary); margin-top:30px; padding:30px; border-radius:15px; min-height:500px; overflow-x:auto;">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>NAME</th>
                                    <th>ROLL</th>
                                    <th>SEC</th>
                                    <th>SUBJECT</th>
                                    <th>SCORE</th>
                                    <th>DATE</th>
                                </tr>
                            </thead>
                            <tbody id="admin-list"></tbody>
                        </table>
                        <div id="admin-empty" style="text-align:center; color:#0f0; margin-top:100px; font-family:monospace;">> DATABASE EMPTY_</div>
                    </div>
                    <button class="btn-nav" style="border-color:red; color:red; margin-top:20px;" onclick="localStorage.clear(); location.reload();">FORMAT DATABASE</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- GLOBAL STORAGE ---
        window.historyDB = {}; window.civicsDB = {}; window.examDB = {};

        // --- AUDIO ENGINE V8 (SAFE) ---
        const AudioSys = {
            muted: false, ctx: null, synth: window.speechSynthesis,
            toggle: function() { this.muted = !this.muted; },
            toggleMusic: function() { alert("Ambience toggled (Placeholder)"); }, // Placeholder for music
            
            play: function(type) {
                if(this.muted) return;
                try {
                    if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    const t=this.ctx.currentTime;
                    
                    if(type==='click') {
                        o.frequency.value=800; g.gain.value=0.05; o.start(); o.stop(t+0.05);
                    } else if(type==='correct') {
                        o.type='triangle'; o.frequency.setValueAtTime(400,t); o.frequency.linearRampToValueAtTime(800,t+0.1);
                        g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.3);
                        o.start(); o.stop(t+0.3);
                    } else if(type==='wrong') {
                        o.type='sawtooth'; o.frequency.setValueAtTime(150,t); g.gain.value=0.1;
                        g.gain.linearRampToValueAtTime(0,t+0.3); o.start(); o.stop(t+0.3);
                    }
                } catch(e) {}
            },

            readQuestion: function() {
                if(this.muted) return;
                const txt = document.getElementById('q-text').innerText;
                const u = new SpeechSynthesisUtterance(txt);
                this.synth.speak(u);
            }
        };

        // --- CORE LOGIC V8 ---
        const Core = {
            user: null, mode: 'history', queue: [], idx: 0, score: 0, timer: null,

            // 1. LOGIN
            login: function() {
                const n = document.getElementById('inp-name').value.trim();
                const r = document.getElementById('inp-roll').value;
                const s = document.getElementById('inp-sec').value;

                if(!n) { alert("Please enter Name"); return; }
                
                // ADMIN BYPASS
                if(n.toLowerCase() === 'sneha' || n.toLowerCase() === 'sneha goyal') {
                    this.loadAdmin(); return;
                }

                if(!r) { alert("Please enter Roll No"); return; }

                this.user = { name:n, roll:r, sec:s };
                document.getElementById('u-name').innerText = n.split(' ')[0];
                document.getElementById('u-roll').innerText = r;
                document.getElementById('user-display').style.display='flex';
                
                AudioSys.play('click');
                this.loadDashboard();
            },

            // 2. DASHBOARD LOGIC
            loadDashboard: function() {
                this.nav('scr-dashboard');
                document.body.className = ''; // Reset theme
                BG.setTheme('default');
                
                document.getElementById('dash-name').innerText = this.user.name;
                document.getElementById('dash-roll').innerText = `${this.user.roll} (${this.user.sec})`;
                
                let allData = JSON.parse(localStorage.getItem('student_personal_data') || "[]");
                let myData = allData.filter(x => x.name === this.user.name);
                
                document.getElementById('dash-tests').innerText = myData.length;
                let best = 0; myData.forEach(d => { if(d.score > best) best = d.score; });
                document.getElementById('dash-best').innerText = best + "/50";
                
                const list = document.getElementById('dash-history');
                list.innerHTML = "";
                if(myData.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#555; margin-top:20px;">No tests taken yet.</div>';
                } else {
                    myData.slice().reverse().forEach(item => {
                        let div = document.createElement('div');
                        div.className = 'hist-item';
                        div.innerHTML = `<span>${item.sub}</span> <span>${item.date}</span> <span style="color:${item.score>=20?'lime':'red'}">${item.score}</span>`;
                        list.appendChild(div);
                    });
                }
            },

            // 3. THEME & LOAD
            setTheme: function(m) {
                this.mode = m;
                document.body.className = `mode-${m}`;
                BG.setTheme(m);
                AudioSys.play('click');
                if(m==='exam') this.loadExam(); else this.renderCh();
            },

            renderCh: function() {
                const list = document.getElementById('ch-list'); list.innerHTML="";
                const hN=["French Rev","Socialism","Nazism","Forests","Pastoralists"];
                const cN=["Democracy","Constitution","Elections","Institutions","Rights"];
                const names = this.mode==='history'?hN:cN;

                document.getElementById('ch-title').innerText = this.mode.toUpperCase();

                for(let i=1; i<=5; i++) {
                    const d=document.createElement('div'); d.className='mod-box';
                    d.style.height='250px'; d.style.width='220px';
                    d.innerHTML = `<div style="font-size:4rem; margin-bottom:15px;">${i}</div><h3>Ch ${i}</h3><p style="font-size:0.8rem; color:#aaa;">${names[i-1]}</p>`;
                    d.onclick=()=>this.loadData(i);
                    list.appendChild(d);
                }
                const all=document.createElement('div'); all.className='mod-box';
                all.style.height='250px'; all.style.width='220px'; all.style.borderColor='var(--primary)';
                all.innerHTML = `<div style="font-size:4rem; margin-bottom:15px;">‚àû</div><h3>FULL MIX</h3>`;
                all.onclick=()=>this.loadData('all');
                list.appendChild(all);
                this.nav('scr-chapters');
            },

            loadData: function(k) {
                document.getElementById('system-loader').style.display='flex';
                let suffix = this.mode==='history'?'':'c';
                if(k==='all') {
                    let c=0; for(let i=1;i<=5;i++) this.inject(`ch${i}${suffix}.js`, ()=>{c++; if(c===5) this.start('all');});
                } else {
                    this.inject(`ch${k}${suffix}.js`, ()=>this.start(k));
                }
            },

            loadExam: function() {
                document.getElementById('system-loader').style.display='flex';
                this.inject('exam.js', ()=>{
                    if(window.examDB && window.examDB.questions) {
                        this.queue = window.examDB.questions;
                        this.initQ();
                    } else {
                        alert("Exam file missing. Using History fallback.");
                        this.mode='history'; this.loadData('all');
                    }
                });
            },

            inject: function(src, cb) {
                if(document.querySelector(`script[src="${src}"]`)) { cb(); return; }
                const s=document.createElement('script'); s.src=src; s.onload=cb;
                s.onerror=()=>{alert("File Missing: "+src); document.getElementById('system-loader').style.display='none';};
                document.body.appendChild(s);
            },

            // 4. QUIZ ENGINE
            start: function(k) {
                let db = this.mode==='history'?window.historyDB:window.civicsDB;
                let pool = [];
                if(k==='all') for(let x in db) pool=pool.concat(db[x]);
                else pool = db[this.mode==='history'?k:k+'c'];

                if(!pool || pool.length===0) { alert("Empty Data"); document.getElementById('system-loader').style.display='none'; return; }

                this.queue = pool.map(q=>({...q, type:'mcq'})).sort(()=>Math.random()-.5).slice(0,50);
                this.initQ();
            },

            initQ: function() {
                document.getElementById('system-loader').style.display='none';
                this.idx=0; this.score=0;
                this.startTimer(this.mode==='exam'?30:15);
                
                // Show Lifelines in Exam Mode
                document.getElementById('lifelines').style.display = (this.mode==='exam') ? 'flex' : 'none';
                
                this.nav('scr-quiz');
                this.renderQ();
            },

            renderQ: function() {
                const q = this.queue[this.idx];
                document.getElementById('tracker').innerText = `${this.idx+1}/${this.queue.length}`;
                document.getElementById('q-text').innerText = q.q;
                document.getElementById('score-box').innerText = this.score;

                const mcq = document.getElementById('mcq-area');
                const txt = document.getElementById('text-area');
                mcq.style.display='none'; txt.style.display='none';
                document.getElementById('hint-msg').style.display='none';
                document.getElementById('txt-ans').value='';

                if(!q.type || q.type==='mcq' || q.type==='case') {
                    mcq.style.display='grid'; mcq.innerHTML='';
                    // Shuffle options
                    let opts = [...q.options].sort(()=>Math.random()-.5);
                    opts.forEach(o=>{
                        const b=document.createElement('div'); b.className='option-btn'; b.innerText=o;
                        // Store correctness for highlighting later
                        if(o === q.ans) b.dataset.correct = "true";
                        b.onclick=()=>this.checkMCQ(b,o,q.ans);
                        mcq.appendChild(b);
                    });
                } else {
                    txt.style.display='flex';
                }
            },

            // SMART HIGHLIGHTING LOGIC
            checkMCQ: function(btn, sel, corr) {
                document.getElementById('mcq-area').style.pointerEvents='none';
                
                if(sel===corr) { 
                    btn.classList.add('correct'); 
                    this.score++; 
                    AudioSys.play('correct'); 
                    VFX.burst(); 
                } else { 
                    btn.classList.add('wrong'); 
                    AudioSys.play('wrong');
                    // Find and highlight the correct one
                    const allBtns = document.getElementById('mcq-area').children;
                    for(let b of allBtns) {
                        if(b.dataset.correct === "true") b.classList.add('correct');
                    }
                }
                setTimeout(()=>this.next(), 1500); // 1.5s delay to read
            },

            // SMART FUZZY TEXT CHECK
            checkText: function() {
                let val = document.getElementById('txt-ans').value.toLowerCase().trim();
                let corr = this.queue[this.idx].ans.toLowerCase();
                let q = this.queue[this.idx];
                let ok = false;

                if(val === corr) ok=true;
                else if(q.keywords) {
                    // Check if input contains at least one keyword
                    if(q.keywords.some(k => val.includes(k.toLowerCase()))) ok=true;
                }
                else if(corr.length > 4 && val.includes(corr)) ok=true;

                if(ok) {
                    this.score++; AudioSys.play('correct'); VFX.burst();
                    setTimeout(()=>this.next(), 600);
                } else {
                    AudioSys.play('wrong');
                    const h=document.getElementById('hint-msg');
                    h.style.display='block'; h.innerText=`Correct Answer: ${q.ans}`;
                    setTimeout(()=>this.next(), 3000);
                }
            },

            // LIFELINE LOGIC
            useLifeline: function(type, btn) {
                if(type === '5050') {
                    btn.disabled = true;
                    btn.style.opacity = "0.5";
                    const allBtns = Array.from(document.getElementById('mcq-area').children);
                    // Filter out the correct answer
                    const wrongBtns = allBtns.filter(b => b.dataset.correct !== "true");
                    // Remove 2 wrong answers
                    for(let i=0; i<2 && i<wrongBtns.length; i++) {
                        wrongBtns[i].style.visibility = "hidden";
                    }
                }
            },

            next: function() {
                this.idx++;
                if(this.idx<this.queue.length) { 
                    document.getElementById('mcq-area').style.pointerEvents='auto';
                    this.renderQ(); 
                } else { this.finish(); }
            },

            finish: function() {
                clearInterval(this.timer);
                this.nav('scr-result');
                document.getElementById('res-name').innerText = this.user.name;
                document.getElementById('res-roll').innerText = this.user.roll;
                document.getElementById('res-sub').innerText = this.mode.toUpperCase();
                document.getElementById('res-score').innerText = this.score;
                
                const d = new Date();
                document.getElementById('res-date').innerText = d.toLocaleDateString();

                let pass = this.score>=20;
                let s = document.getElementById('res-stamp');
                if(pass) { s.innerText="PASS"; s.className="stamp pass"; VFX.confetti(); }
                else { s.innerText="FAIL"; s.className="stamp fail"; }
                
                this.saveData();
            },

            saveData: function() {
                let entry = {
                    name: this.user.name, roll: this.user.roll, sec: this.user.sec,
                    sub: this.mode.toUpperCase(), score: this.score, date: new Date().toLocaleDateString()
                };
                
                let tDB = JSON.parse(localStorage.getItem('sneha_class_data') || "[]");
                tDB.push(entry);
                localStorage.setItem('sneha_class_data', JSON.stringify(tDB));

                let sDB = JSON.parse(localStorage.getItem('student_personal_data') || "[]");
                sDB.push(entry);
                localStorage.setItem('student_personal_data', JSON.stringify(sDB));
            },

            finishToDash: function() { this.loadDashboard(); },
            logout: function() { location.reload(); },

            // ADMIN
            loadAdmin: function() {
                this.nav('scr-admin');
                document.body.className = 'mode-admin';
                const list = document.getElementById('admin-list');
                const empty = document.getElementById('admin-empty');
                list.innerHTML = "";
                
                let data = JSON.parse(localStorage.getItem('sneha_class_data') || "[]");
                
                if(data.length === 0) empty.style.display='block';
                else {
                    empty.style.display='none';
                    data.reverse().forEach(row => {
                        let tr = document.createElement('tr');
                        tr.innerHTML = `<td>${row.name}</td><td>${row.roll}</td><td>${row.sec}</td><td>${row.sub}</td><td style="color:${row.score>=20?'lime':'red'}">${row.score}</td><td>${row.date}</td>`;
                        list.appendChild(tr);
                    });
                }
            },

            nav: function(id) {
                document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },
            startTimer: function(min) {
                clearInterval(this.timer);
                let t=min*60;
                this.timer=setInterval(()=>{
                    t--;
                    let m=Math.floor(t/60), s=t%60;
                    document.getElementById('timer').innerText=`${m}:${s<10?'0'+s:s}`;
                    if(t<=0) this.finish();
                },1000);
            }
        };

        // --- BACKGROUND FX ENGINE ---
        const BG = {
            c: document.getElementById('bg-canvas'),
            ctx: document.getElementById('bg-canvas').getContext('2d'),
            mode: 'default',
            particles: [],
            
            init: function() {
                this.resize(); window.onresize=()=>this.resize();
                this.createParticles();
                this.loop();
            },
            resize: function() { this.c.width=window.innerWidth; this.c.height=window.innerHeight; },
            setTheme: function(m) { this.mode=m; this.createParticles(); },
            
            createParticles: function() {
                this.particles = [];
                let color = 'rgba(255,255,255,0.1)';
                if(this.mode==='history') color='rgba(0,242,255,0.2)'; // Blue Rain
                if(this.mode==='civics') color='rgba(255,204,0,0.2)'; // Gold Float
                if(this.mode==='exam') color='rgba(255,0,85,0.2)'; // Red Pulse

                for(let i=0; i<60; i++) {
                    this.particles.push({
                        x: Math.random()*this.c.width,
                        y: Math.random()*this.c.height,
                        s: Math.random()*3,
                        v: (Math.random()+0.5),
                        c: color
                    });
                }
            },
            
            loop: function() {
                this.ctx.clearRect(0,0,this.c.width,this.c.height);
                this.particles.forEach(p => {
                    if(this.mode==='history') p.y += p.v * 2; // Rain down
                    else if(this.mode==='civics') p.y -= p.v; // Float up
                    else p.y += Math.sin(Date.now()/1000) * p.v; // Pulse/Hover

                    if(p.y > this.c.height) p.y=0;
                    if(p.y < 0) p.y=this.c.height;

                    this.ctx.fillStyle = p.c;
                    this.ctx.beginPath(); this.ctx.arc(p.x,p.y,p.s,0,Math.PI*2); this.ctx.fill();
                });
                requestAnimationFrame(()=>this.loop());
            }
        };

        // --- BURST VFX ---
        const VFX = {
            c: document.getElementById('vfx-canvas'), ctx: document.getElementById('vfx-canvas').getContext('2d'), parts: [],
            init: function() { this.c.width=window.innerWidth; this.c.height=window.innerHeight; this.loop(); },
            burst: function() {
                let x=this.c.width/2, y=this.c.height/2;
                for(let i=0;i<30;i++) this.parts.push({x:x,y:y,vx:(Math.random()-.5)*20,vy:(Math.random()-.5)*20,life:1,c:'rgba(0,255,136,'});
            },
            confetti: function() {
                for(let i=0;i<100;i++) this.parts.push({x:this.c.width/2,y:this.c.height/2,vx:(Math.random()-.5)*25,vy:(Math.random()-1)*20,life:2,grav:0.5,c:`rgba(${Math.random()*255},${Math.random()*255},255,`});
            },
            loop: function() {
                this.ctx.clearRect(0,0,this.c.width,this.c.height);
                this.parts.forEach((p,i)=>{
                    p.x+=p.vx; p.y+=p.vy; if(p.grav) p.vy+=p.grav; p.life-=0.02;
                    if(p.life<=0) this.parts.splice(i,1);
                    this.ctx.beginPath(); this.ctx.arc(p.x,p.y,4,0,Math.PI*2); this.ctx.fillStyle=p.c+p.life+')'; this.ctx.fill();
                });
                requestAnimationFrame(()=>this.loop());
            }
        };

        window.onload = () => {
            setTimeout(()=>{ document.getElementById('system-loader').style.display='none'; BG.init(); VFX.init(); },1200);
        };
    </script>
</body>
</html>
